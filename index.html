
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TT Cargo Pilot Helper</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Roboto:wght@400;700&display=swap');

        :root {
            --primary: #0277bd;
            --primary-dim: #004c8c;
            --bg-glass: rgba(15, 15, 15, 0.95);
            --text-main: #ffffff;
            --text-dim: #aaaaaa;
            --border: 1px solid rgba(2, 119, 189, 0.3);
            --green: #00e676;
            --orange: #ff9800;
            --accent: #ffc107;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: transparent;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh; width: 100vw;
            user-select: none;
        }

        .tracker-app {
            position: absolute;
            top: 20px; 
            left: 2vw;
            width: 96vw;
            max-width: 1800px;
            height: 140px;
            background: var(--bg-glass);
            border: var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
            resize: both; overflow: hidden;
            min-height: 140px;
            transition: none;
        }
        
        #tracker-app { top: 20px; }
        #trucking-tracker-app { top: 180px; display: none; }

        /* --- MINI MODE --- */
        #tracker-app.mini-mode {
            width: 420px !important;
            height: 74px !important;
            min-height: 74px !important;
            border-radius: 12px;
            background: rgba(10, 10, 10, 0.98);
            border: 1px solid var(--primary);
            resize: none;
        }

        #tracker-app.mini-mode header, 
        #tracker-app.mini-mode #sky-container,
        #tracker-app.mini-mode #content { display: none !important; }
        
        #trucking-tracker-app.mini-mode header, 
        #trucking-tracker-app.mini-mode #trucking-sky-container,
        #trucking-tracker-app.mini-mode #trucking-content { display: none !important; }

        #micro-view,
        #trucking-micro-view {
            display: none;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            padding: 0 12px;
            font-family: 'Rajdhani', sans-serif;
            cursor: move;
        }
        #tracker-app.mini-mode #micro-view { display: flex; }
        #trucking-tracker-app.mini-mode #trucking-micro-view { display: flex; }

        .micro-row { display: flex; justify-content: space-between; align-items: center; width: 100%; height: 50%; }
        .micro-group { display: flex; align-items: center; gap: 8px; }
        .micro-sep { width: 1px; height: 12px; background: rgba(255,255,255,0.2); }
        .micro-label { color: var(--text-dim); font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; }
        .micro-val { color: #fff; font-weight: 700; font-size: 0.9em; }
        .micro-val.highlight { color: var(--primary); }
        .micro-val.active { color: var(--green); }
        
        .micro-progress-bg { width: 60px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin: 0 5px; }
        .micro-progress-fill { height: 100%; background: var(--primary); width: 0%; }

        .micro-btn {
            position: absolute; top: 4px; right: 4px;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: #aaa; padding: 0px 4px; border-radius: 3px; font-size: 0.6em; cursor: pointer;
        }
        .micro-btn:hover { background: var(--primary); color: white; }

        /* --- HEADER & ANIMATION --- */
        header {
            background: linear-gradient(180deg, var(--primary-dim), rgba(2, 119, 189, 0.2));
            height: 40px;
            padding: 0 10px;
            cursor: move;
            position: relative;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.15);
            overflow: hidden;
        }
        
        #trucking-drag-handle {
            background: linear-gradient(180deg, #994400, rgba(204, 85, 0, 0.2));
        }

        .header-title {
            position: absolute; left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Rajdhani', sans-serif; 
            font-weight: 900; font-size: 1em;
            text-transform: uppercase; letter-spacing: 2px;
            color: #fff; pointer-events: none; white-space: nowrap;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
        }
        

        /* ANIMATION CONTAINER */
        #sky-container,
        #trucking-sky-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 5;
            display: none;
        }

        /* PARACHUTE & CRATE GROUP */
        .drop-group {
            position: absolute;
            top: -90px; /* Start higher up due to larger size */
            display: flex; flex-direction: column; align-items: center;
            opacity: 0.8;
        }

        .parachute {
            font-size: 2.2em; /* Increased size further */
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
            z-index: 6;
        }

        .crate {
            font-size: 1.8em; /* Increased size further */
            margin-top: -5px; /* Connect visually */
            animation: crateWiggle 2s ease-in-out infinite alternate;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
            transform-origin: top center; /* Swing from top */
        }

        /* ANIMATIONS */
        @keyframes dropFall {
            0% { top: -90px; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 110px; opacity: 0; } /* Fall past bottom */
        }

        @keyframes crateWiggle {
            from { transform: rotate(-15deg); }
            to { transform: rotate(15deg); }
        }

        /* 5 UNIQUE DROPS */
        .drop-1 { left: 10%; animation: dropFall 8s linear infinite; transform: scale(0.8); }
        .drop-2 { left: 30%; animation: dropFall 6s linear infinite 2s; transform: scale(1); }
        .drop-3 { left: 50%; animation: dropFall 9s linear infinite 1s; transform: scale(0.7); }
        .drop-4 { left: 70%; animation: dropFall 7s linear infinite 4s; transform: scale(0.9); }
        .drop-5 { left: 90%; animation: dropFall 10s linear infinite 0.5s; transform: scale(0.6); }


        .header-controls { display: flex; gap: 6px; z-index: 20; align-items: center; }
        .nav-icon { text-decoration: none; font-size: 1em; cursor: pointer; color: #ccc; }
        .nav-icon:hover { color: #fff; }
        
        #mini-btn,
        #trucking-mini-btn { font-family: 'Rajdhani', sans-serif; font-weight: bold; font-size: 0.7em; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: #ccc; padding: 2px 5px; border-radius: 4px; cursor: pointer; }
        #mini-btn:hover,
        #trucking-mini-btn:hover { background: var(--primary); color: white; border-color: var(--accent); }
        
        #clock,
        #trucking-clock { font-family: 'Rajdhani', sans-serif; font-weight: 700; color: #fff; font-size: 0.75em; z-index: 20; }

        /* --- CONTENT --- */
        #content,
        #trucking-content { padding: 8px 12px; flex: 1; overflow-y: hidden; overflow-x: auto; scrollbar-width: thin; display: flex; flex-direction: row; gap: 12px; align-items: stretch; }

        .destination-display { background: rgba(255, 193, 7, 0.1); border: 1px dashed var(--accent); border-radius: 6px; padding: 8px 15px; text-align: center; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; min-width: 200px; flex-shrink: 0; }
        .dest-label { font-size: 0.65em; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        .dest-value { font-family: 'Rajdhani', sans-serif; font-size: 1.1em; font-weight: 700; color: #fff; text-shadow: 0 0 10px rgba(0,0,0,0.5); white-space: nowrap; }
        
        .multi-warning { display: none; font-size: 0.65em; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; animation: warnPulse 1s infinite alternate; }
        @keyframes warnPulse { from { color: white; text-shadow: 0 0 2px black; } to { color: #ff3333; text-shadow: 0 0 10px red; } }

        .horizontal-row { display: flex; gap: 12px; align-items: center; flex-wrap: nowrap; flex: 1; padding: 0 10px; }
        .stat-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; min-width: fit-content; }
        .stat-separator { width: 1px; height: 40px; background: rgba(255,255,255,0.15); flex-shrink: 0; }

        .label { font-size: 0.65em; color: var(--text-dim); text-transform: uppercase; margin-bottom: 2px; white-space: nowrap; }
        .value { font-size: 1em; font-weight: bold; color: var(--text-main); white-space: nowrap; }
        .value.highlight { color: var(--primary); }
        .value.bxp { color: var(--green); }

        .progress-container { position: relative; height: 14px; background: rgba(0,0,0,0.5); border-radius: 4px; margin: 0; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.65em; text-shadow: 1px 1px 2px black; font-weight: bold; z-index: 2; }



        .sync-dot { height: 6px; width: 6px; border-radius: 50%; display: inline-block; background: #444; margin-left: 4px; vertical-align: middle; }
        .sync-dot.live { background: var(--green); box-shadow: 0 0 5px var(--green); }
        .sync-dot.cached { background: var(--orange); }

        input[type="number"] { width: 100%; background: rgba(0,0,0,0.4); border: 1px solid #444; color: white; padding: 3px 5px; border-radius: 3px; font-family: inherit; font-size: 0.8em; }
        input:focus { outline: 1px solid var(--primary); border-color: var(--primary); }
        
        .quick-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #ccc; font-size: 0.65em; padding: 3px 6px; border-radius: 3px; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-weight: bold; white-space: nowrap; }
        .quick-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

        #job-list, #summary-table { display: none !important; }
        
        #control-panel { 
            display: none; 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            background: var(--bg-glass); 
            border: var(--border); 
            border-radius: 12px; 
            padding: 25px; 
            min-width: 400px;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.9); 
            z-index: 2000;
            backdrop-filter: blur(10px);
        }
        #control-panel.show { display: block; }
        
        #control-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
        }
        #control-overlay.show { display: block; }
        
        .control-header {
            font-size: 1.4em;
            font-weight: 900;
            margin-bottom: 20px;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            font-family: 'Rajdhani', sans-serif;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }
        
        #settings-panel,
        #trucking-settings-panel { 
            display: none; 
            position: absolute; 
            top: 50px; 
            right: 10px; 
            background: var(--bg-glass); 
            border: var(--border); 
            border-radius: 8px; 
            padding: 15px; 
            min-width: 320px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8); 
            z-index: 1000; 
        }
        #settings-panel.show,
        #trucking-settings-panel.show { display: block; }
        
        #trucking-settings-panel {
            border-color: #cc5500;
        }
        
        #minimized-bar {
            display: none;
            position: absolute;
            top: 20px;
            left: 2vw;
            background: var(--bg-glass);
            border: var(--border);
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            z-index: 999;
        }
        #minimized-bar:hover { border-color: var(--primary); }
        #minimized-bar.show { display: block; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .settings-row:last-child { border-bottom: none; margin-bottom: 0; }
        .settings-label { font-size: 0.85em; color: var(--text-dim); }
        .settings-control { display: flex; gap: 5px; align-items: center; }
        
        .control-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); }
        .control-row:hover { background: rgba(255,255,255,0.05); border-color: var(--primary); }
        .control-label { font-size: 0.95em; color: var(--text-main); font-weight: 500; }
        .control-toggle { display: flex; gap: 8px; align-items: center; }
        .font-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #ccc; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em; }
        .font-btn:hover { background: var(--primary); color: white; }
        .font-value { color: var(--primary); font-weight: bold; min-width: 35px; text-align: center; }
        .settings-icon { cursor: pointer; font-size: 1em; color: #ccc; }
        .settings-icon:hover { color: #fff; }
        
        .opacity-slider { width: 120px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; appearance: none; cursor: pointer; }
        .opacity-slider::-webkit-slider-thumb { appearance: none; width: 12px; height: 12px; background: var(--primary); border-radius: 50%; cursor: pointer; }
        .opacity-slider::-moz-range-thumb { width: 12px; height: 12px; background: var(--primary); border-radius: 50%; cursor: pointer; border: none; }
        
        .minimize-btn { cursor: pointer; font-size: 1em; color: #ccc; margin-left: 5px; }
        .minimize-btn:hover { color: #fff; }
        
        #settings-panel input[type="checkbox"],
        #control-panel input[type="checkbox"] { 
            width: 18px; 
            height: 18px; 
            cursor: pointer; 
            accent-color: var(--primary); 
        }
    </style>
</head>
<body>

<div id="tracker-app" class="tracker-app">
    <div id="micro-view" onmousedown="dragMouseDown(event)">
        <button class="micro-btn" onclick="toggleMini()">EXPAND</button>
        
        <div class="micro-row" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div class="micro-group">
                <span style="font-size:1.2em">üì¶</span>
                <span class="micro-val highlight">ZG OPS</span>
            </div>
            <div class="micro-group">
                <span class="micro-label">Dest:</span>
                <span class="micro-val" id="micro-dest" style="max-width:140px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">--</span>
            </div>
            <div class="micro-group">
                <span class="micro-label">Load:</span>
                <span class="micro-val active" id="micro-weight">0kg</span>
            </div>
        </div>

        <div class="micro-row">
            <div class="micro-group" style="min-width: 90px;">
                <span class="micro-label">Lvl</span>
                <span class="micro-val highlight" id="micro-level">0</span>
                <div class="micro-progress-bg">
                    <div class="micro-progress-fill" id="micro-bar"></div>
                </div>
            </div>
            <div class="micro-sep"></div>
            <div class="micro-group">
                <span class="micro-label">XP:</span>
                <span class="micro-val" id="micro-xp">0</span>
            </div>
            <div class="micro-sep"></div>
            <div class="micro-group">
                <span class="micro-label">Tok:</span>
                <span class="micro-val active" id="micro-tokens">0</span>
            </div>
            <div class="micro-sep"></div>
            <div class="micro-group">
                <span class="micro-label">Left:</span>
                <span class="micro-val highlight" id="micro-calc">--</span>
            </div>
        </div>
    </div>

    <header id="drag-handle">
        <div class="header-controls">
            <span class="settings-icon" onclick="toggleSettings()">‚öôÔ∏è</span>
        </div>
        
        <div class="header-title">Cargo Tracker</div>
        
        <div id="sky-container">
            <div class="drop-group drop-1"><div class="parachute">ü™Ç</div><div class="crate">üì¶</div></div>
            <div class="drop-group drop-2"><div class="parachute">ü™Ç</div><div class="crate">üì¶</div></div>
            <div class="drop-group drop-3"><div class="parachute">ü™Ç</div><div class="crate">üì¶</div></div>
            <div class="drop-group drop-4"><div class="parachute">ü™Ç</div><div class="crate">üì¶</div></div>
            <div class="drop-group drop-5"><div class="parachute">ü™Ç</div><div class="crate">üì¶</div></div>
        </div>

        <div class="header-controls" style="flex-direction:row; gap:6px; align-items:center;">
            <span class="minimize-btn" onclick="minimizeUI()" title="Minimize">‚àí</span>
            <button id="mini-btn" onclick="toggleMini()">MINI</button>
            <span id="clock">00:00</span>
        </div>
    </header>

    <div id="content">
        
        <div class="destination-display" id="dest-box" data-visible="true">
            <div class="dest-label">Next Destination</div>
            <div class="dest-value" id="disp-destination">Waiting for cargo...</div>
            <div id="multi-warning" class="multi-warning">‚ö† Multiple Cargo Types ‚ö†</div>
        </div>

        <div class="horizontal-row">
            <div class="stat-item">
                <div class="label">Pilot Level</div>
                <div class="value highlight" style="font-size:1.4em" id="disp-level">...</div>
            </div>

            <div class="stat-separator"></div>

            <div class="stat-item">
                <div class="label">Current XP</div>
                <div class="value" id="disp-xp">0</div>
            </div>

            <div class="stat-separator"></div>

            <div class="stat-item">
                <div class="label">Progress</div>
                <div class="progress-container" style="width:120px;">
                    <div class="progress-bar" id="level-bar"></div>
                    <div class="progress-text" id="level-text">0%</div>
                </div>
            </div>

            <div class="stat-separator"></div>

            <div class="stat-item">
                <div class="label">XP To Next</div>
                <div class="value" id="disp-xp-remaining">0</div>
            </div>

            <div class="stat-separator"></div>

            <div class="stat-item">
                <div class="label">Current Flight XP</div>
                <div class="value" id="disp-flight-xp" style="color:var(--green)">0 XP</div>
            </div>

            <div class="stat-separator"></div>

            <div class="stat-item">
                <div class="label">Avg XP/Flight</div>
                <div class="value" id="disp-flight-avg">0 XP</div>
            </div>

            <div class="stat-separator"></div>

            <div class="stat-item">
                <div class="label">BXP Tokens</div>
                <div class="value bxp" id="disp-bxp">0</div>
            </div>

            <div class="stat-separator"></div>

            <div class="stat-item">
                <div class="label">Flights Done</div>
                <div class="value" id="disp-ops" style="color:var(--accent)">0</div>
            </div>

            <div class="stat-separator"></div>

            <div class="stat-item" style="min-width:150px;">
                <div class="label">üì¶ Cargo <span id="sync-status" class="sync-dot"></span></div>
                <div class="value" id="trunk-capacity" style="font-size:0.85em;">0/0kg</div>
            </div>

            <div class="stat-separator" id="calc-sep-1" data-visible="true"></div>

            <div class="stat-item" id="calc-input-section" style="min-width:180px;" data-visible="true">
                <div class="label">Flight Calculator</div>
                <div style="display:flex; gap:3px; align-items:center;">
                    <input type="number" id="target-input" placeholder="Target XP" style="width:100px; margin:0;">
                    <button class="quick-btn" onclick="setCalc(100000)" style="margin:0;">100K</button>
                    <button class="quick-btn" onclick="setCalc(1000000)" style="margin:0;">1M</button>
                </div>
            </div>

            <div class="stat-separator" id="calc-sep-2" data-visible="true"></div>

            <div class="stat-item" id="calc-result-section" data-visible="true">
                <div class="label">Flights Left</div>
                <div class="value" id="calc-result">--</div>
            </div>
        </div>
        
        <div id="trunk-list" style="display:none;"></div>

    </div>
    <div id="resize-handle" style="position:absolute; bottom:0; right:0; width:15px; height:15px; cursor:nwse-resize;"></div>
</div>

<div id="trucking-tracker-app" class="tracker-app">
    <div id="trucking-micro-view" onmousedown="dragMouseDownTrucking(event)">
        <button class="micro-btn" onclick="toggleMiniTrucking()">EXPAND</button>
        
        <div class="micro-row" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div class="micro-group">
                <span style="font-size:1.2em">üöõ</span>
                <span class="micro-val highlight">TRUCKING</span>
            </div>
            <div class="micro-group">
                <span class="micro-label">Dest:</span>
                <span class="micro-val" id="trucking-micro-dest" style="max-width:140px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">--</span>
            </div>
            <div class="micro-group">
                <span class="micro-label">Load:</span>
                <span class="micro-val active" id="trucking-micro-weight">0kg</span>
            </div>
        </div>

        <div class="micro-row">
            <div class="micro-group" style="min-width: 90px;">
                <span class="micro-label">Lvl</span>
                <span class="micro-val highlight" id="trucking-micro-level">0</span>
                <div class="micro-progress-bg">
                    <div class="micro-progress-fill" id="trucking-micro-bar"></div>
                </div>
            </div>
            <div class="micro-sep"></div>
            <div class="micro-group">
                <span class="micro-label">XP:</span>
                <span class="micro-val" id="trucking-micro-xp">0</span>
            </div>
            <div class="micro-sep"></div>
            <div class="micro-group">
                <span class="micro-label">Tok:</span>
                <span class="micro-val active" id="trucking-micro-tokens">0</span>
            </div>
            <div class="micro-sep"></div>
            <div class="micro-group">
                <span class="micro-label">Left:</span>
                <span class="micro-val highlight" id="trucking-micro-calc">--</span>
            </div>
        </div>
    </div>

    <header id="trucking-drag-handle">
        <div class="header-controls">
            <span class="settings-icon" onclick="toggleTruckingSettings()">‚öôÔ∏è</span>
        </div>
        
        <div class="header-title">Trucking Tracker</div>
        
        <div id="trucking-sky-container">
            <div class="drop-group drop-1"><div class="parachute">üöõ</div><div class="crate">üì¶</div></div>
            <div class="drop-group drop-2"><div class="parachute">üöõ</div><div class="crate">üì¶</div></div>
            <div class="drop-group drop-3"><div class="parachute">üöõ</div><div class="crate">üì¶</div></div>
            <div class="drop-group drop-4"><div class="parachute">üöõ</div><div class="crate">üì¶</div></div>
            <div class="drop-group drop-5"><div class="parachute">üöõ</div><div class="crate">üì¶</div></div>
        </div>

        <div class="header-controls" style="flex-direction:row; gap:6px; align-items:center;">
            <span class="minimize-btn" onclick="minimizeUITrucking()" title="Minimize">‚àí</span>
            <button id="trucking-mini-btn" onclick="toggleMiniTrucking()">MINI</button>
            <span id="trucking-clock">00:00</span>
        </div>
    </header>

    <div id="trucking-content">
        
        <div class="horizontal-row">
            <div class="stat-item">
                <div class="label">Trucker Level</div>
                <div class="value highlight" style="font-size:1.4em" id="trucking-disp-level">...</div>
            </div>

            <div class="stat-separator"></div>

            <div class="stat-item">
                <div class="label">Current XP</div>
                <div class="value" id="trucking-disp-xp">0</div>
            </div>

            <div class="stat-separator"></div>

            <div class="stat-item">
                <div class="label">Progress</div>
                <div class="progress-container" style="width:120px;">
                    <div class="progress-bar" id="trucking-level-bar"></div>
                    <div class="progress-text" id="trucking-level-text">0%</div>
                </div>
            </div>

            <div class="stat-separator"></div>

            <div class="stat-item">
                <div class="label">XP To Next</div>
                <div class="value" id="trucking-disp-xp-remaining">0</div>
            </div>

            <div class="stat-separator"></div>

            <div class="stat-item">
                <div class="label">Current Run XP</div>
                <div class="value" id="trucking-disp-flight-xp" style="color:var(--green)">0 XP</div>
            </div>

            <div class="stat-separator"></div>

            <div class="stat-item">
                <div class="label">Avg XP/Run</div>
                <div class="value" id="trucking-disp-flight-avg">0 XP</div>
            </div>

            <div class="stat-separator"></div>

            <div class="stat-item">
                <div class="label">BXP Tokens</div>
                <div class="value bxp" id="trucking-disp-bxp">0</div>
            </div>

            <div class="stat-separator"></div>

            <div class="stat-item">
                <div class="label">Runs Done</div>
                <div class="value" id="trucking-disp-ops" style="color:var(--accent)">0</div>
            </div>

            <div class="stat-separator"></div>

            <div class="stat-item" style="min-width:150px;">
                <div class="label">üöõ Cargo <span id="trucking-sync-status" class="sync-dot"></span></div>
                <div class="value" id="trucking-trunk-capacity" style="font-size:0.85em;">0/0kg</div>
            </div>

            <div class="stat-separator" id="trucking-calc-sep-1" data-visible="true"></div>

            <div class="stat-item" id="trucking-calc-input-section" style="min-width:180px;" data-visible="true">
                <div class="label">Run Calculator</div>
                <div style="display:flex; gap:3px; align-items:center;">
                    <input type="number" id="trucking-target-input" placeholder="Target XP" style="width:100px; margin:0;">
                    <button class="quick-btn" onclick="setCalcTrucking(100000)" style="margin:0;">100K</button>
                    <button class="quick-btn" onclick="setCalcTrucking(1000000)" style="margin:0;">1M</button>
                </div>
            </div>

            <div class="stat-separator" id="trucking-calc-sep-2" data-visible="true"></div>

            <div class="stat-item" id="trucking-calc-result-section" data-visible="true">
                <div class="label">Runs Left</div>
                <div class="value" id="trucking-calc-result">--</div>
            </div>
        </div>
        
        <div id="trucking-trunk-list" style="display:none;"></div>

    </div>
    <div id="trucking-resize-handle" style="position:absolute; bottom:0; right:0; width:15px; height:15px; cursor:nwse-resize;"></div>
</div>

<div id="minimized-bar" onclick="restoreUI()">
    <span style="font-family:'Rajdhani',sans-serif; font-weight:700; color:var(--primary); font-size:0.9em;">ZG OPS</span>
    <span style="color:#888; font-size:0.8em; margin-left:10px;">Click to restore</span>
</div>

<div id="control-overlay"></div>

<div id="control-panel">
    <div class="control-header">‚öôÔ∏è ZG OPS Control Panel</div>
    
    <div class="control-row">
        <div class="control-label">üì¶ Show Cargo Tracker</div>
        <div class="control-toggle">
            <input type="checkbox" id="control-show-tracker" checked onchange="toggleTrackerUI()">
        </div>
    </div>
    
    <div class="control-row">
        <div class="control-label">üöõ Show Trucking Tracker</div>
        <div class="control-toggle">
            <input type="checkbox" id="control-show-trucking" onchange="toggleTruckingUI()">
        </div>
    </div>
    
    <div style="font-size:0.9em; color:var(--primary); font-weight:bold; margin:15px 0 10px 0; padding-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.1);">üì¶ CARGO TRACKER</div>
    
    <div class="control-row">
        <div class="control-label">Show Destination</div>
        <div class="control-toggle">
            <input type="checkbox" id="control-show-destination" checked onchange="toggleDestinationFromControl()">
        </div>
    </div>
    
    <div class="control-row">
        <div class="control-label">Show Calculator</div>
        <div class="control-toggle">
            <input type="checkbox" id="control-show-calculator" checked onchange="toggleCalculatorFromControl()">
        </div>
    </div>
    
    <div class="control-row">
        <div class="control-label">Font Size</div>
        <div class="control-toggle">
            <button class="font-btn" onclick="changeCargoFontSize(-1)">‚àí</button>
            <span class="font-value" id="control-font-size-display">100%</span>
            <button class="font-btn" onclick="changeCargoFontSize(1)">+</button>
        </div>
    </div>
    
    <div class="control-row">
        <div class="control-label">Opacity</div>
        <div class="control-toggle">
            <input type="range" class="opacity-slider" id="control-opacity-slider" min="50" max="100" value="95" oninput="changeCargoOpacity(this.value)">
            <span class="font-value" id="control-opacity-display">95%</span>
        </div>
    </div>
    
    <div style="font-size:0.9em; color:#cc5500; font-weight:bold; margin:15px 0 10px 0; padding-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.1);">üöõ TRUCKING TRACKER</div>
    
    <div class="control-row">
        <div class="control-label">Show Calculator</div>
        <div class="control-toggle">
            <input type="checkbox" id="control-show-trucking-calculator" checked onchange="toggleTruckingCalculatorFromControl()">
        </div>
    </div>
    
    <div class="control-row">
        <div class="control-label">Font Size</div>
        <div class="control-toggle">
            <button class="font-btn" onclick="changeTruckingFontSize(-1)">‚àí</button>
            <span class="font-value" id="control-trucking-font-size">100%</span>
            <button class="font-btn" onclick="changeTruckingFontSize(1)">+</button>
        </div>
    </div>
    
    <div class="control-row">
        <div class="control-label">Opacity</div>
        <div class="control-toggle">
            <input type="range" class="opacity-slider" id="control-trucking-opacity" min="50" max="100" value="95" oninput="changeTruckingOpacity(this.value)">
            <span class="font-value" id="control-trucking-opacity-display">95%</span>
        </div>
    </div>
    
    <div style="display:flex; gap:10px; margin-top:20px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1);">
        <button class="font-btn" onclick="resetSettings()" style="flex:1;">Reset All Settings</button>
        <button class="font-btn" onclick="toggleControlPanel()" style="flex:1; background:var(--primary); color:white;">Close (F2)</button>
    </div>
    
    <div style="text-align:center; margin-top:15px; font-size:0.75em; color:var(--text-dim);">
        Press <span style="color:var(--primary); font-weight:bold;">F2</span> to toggle this panel
    </div>
</div>

<div id="settings-panel">
    <div style="font-size:1.1em; font-weight:bold; margin-bottom:15px; color:var(--primary); text-transform:uppercase; letter-spacing:1px;">Quick Settings</div>
    
    <div style="font-size:0.75em; color:var(--text-dim); margin-bottom:10px; font-style:italic;">
        üí° Use F2 for full control panel
    </div>
    
    <div style="border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:10px; padding-bottom:10px;">
        <div style="font-size:0.85em; color:var(--primary); font-weight:bold; margin-bottom:8px;">üì¶ CARGO SETTINGS</div>
        
        <div class="settings-row" style="border-bottom:none; margin-bottom:5px; padding-bottom:5px;">
            <div class="settings-label">Show Destination</div>
            <div class="settings-control">
                <input type="checkbox" id="show-destination" checked onchange="toggleDestination()">
            </div>
        </div>
        
        <div class="settings-row" style="border-bottom:none; margin-bottom:5px; padding-bottom:5px;">
            <div class="settings-label">Show Calculator</div>
            <div class="settings-control">
                <input type="checkbox" id="show-calculator" checked onchange="toggleCalculator()">
            </div>
        </div>
        
        <div class="settings-row" style="border-bottom:none; margin-bottom:5px; padding-bottom:5px;">
            <div class="settings-label">Font Size</div>
            <div class="settings-control">
                <button class="font-btn" onclick="changeCargoFontSize(-1)">‚àí</button>
                <span class="font-value" id="font-size-display">100%</span>
                <button class="font-btn" onclick="changeCargoFontSize(1)">+</button>
            </div>
        </div>
        
        <div class="settings-row" style="border-bottom:none; margin-bottom:0; padding-bottom:0;">
            <div class="settings-label">Opacity</div>
            <div class="settings-control">
                <input type="range" class="opacity-slider" id="opacity-slider" min="50" max="100" value="95" oninput="changeCargoOpacity(this.value)">
                <span class="font-value" id="opacity-display">95%</span>
            </div>
        </div>
    </div>
    
    <div class="settings-row" style="border-bottom:none; margin-bottom:0; padding-bottom:0;">
        <div class="settings-label">Reset Cargo Settings</div>
        <div class="settings-control">
            <button class="font-btn" onclick="resetCargoSettings()">Reset</button>
        </div>
    </div>
</div>

<div id="trucking-settings-panel">
    <div style="font-size:1.1em; font-weight:bold; margin-bottom:15px; color:#cc5500; text-transform:uppercase; letter-spacing:1px;">üöõ Trucking Settings</div>
    
    <div style="font-size:0.75em; color:var(--text-dim); margin-bottom:10px; font-style:italic;">
        üí° Use F2 for full control panel
    </div>
    
    <div style="border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:10px; padding-bottom:10px;">
        <div style="font-size:0.85em; color:#cc5500; font-weight:bold; margin-bottom:8px;">üöõ TRUCKING SETTINGS</div>
        
        <div class="settings-row" style="border-bottom:none; margin-bottom:5px; padding-bottom:5px;">
            <div class="settings-label">Show Calculator</div>
            <div class="settings-control">
                <input type="checkbox" id="show-trucking-calculator" checked onchange="toggleTruckingCalculator()">
            </div>
        </div>
        
        <div class="settings-row" style="border-bottom:none; margin-bottom:5px; padding-bottom:5px;">
            <div class="settings-label">Font Size</div>
            <div class="settings-control">
                <button class="font-btn" onclick="changeTruckingFontSize(-1)">‚àí</button>
                <span class="font-value" id="trucking-font-size-display">100%</span>
                <button class="font-btn" onclick="changeTruckingFontSize(1)">+</button>
            </div>
        </div>
        
        <div class="settings-row" style="border-bottom:none; margin-bottom:0; padding-bottom:0;">
            <div class="settings-label">Opacity</div>
            <div class="settings-control">
                <input type="range" class="opacity-slider" id="trucking-opacity-slider" min="50" max="100" value="95" oninput="changeTruckingOpacity(this.value)">
                <span class="font-value" id="trucking-opacity-display">95%</span>
            </div>
        </div>
    </div>
    
    <div class="settings-row" style="border-bottom:none; margin-bottom:0; padding-bottom:0;">
        <div class="settings-label">Reset Trucking Settings</div>
        <div class="settings-control">
            <button class="font-btn" onclick="resetTruckingSettings()">Reset</button>
        </div>
    </div>
</div>

<div id="job-list" style="display:none;"></div>
<table id="summary-table" style="display:none;"></table>

<script>
// --- AIRPORT DATABASE ---
const AIRPORTS = {
    "LSIA": "Los Santos INTL.", "SSIA": "Sandy Sh. INTL. Airport", "ZMA": "Zancudo Military Airport",
    "RAM": "Arroyo Muerto Municipal", "PBA": "Arroyo Muerto Municipal", 
    "POA": "Pacific Ocean Airport", "MGA": "Mount Gorgo Airport",
    "CIA": "Chumash Island Airport", "SCA": "San Chianski Airport", "POP": "PostOp Airport",
    "SAN": "Sandy Shores Airfield", "MKA": "McKenzie Airfield", "CPA": "Cayo Perico Airfield",
    "TVH": "Tongva Hills Airfield", "CV": "Carrier"
};

// --- STATE ---
let TRUNK_KEY = null;
let LAST_VEHICLE = null; 
const STORAGE_KEY_CALC = "target_xp_cargo";
const STORAGE_KEY_MINI = "mini_mode_cargo";
const STORAGE_KEY_FONTSIZE = "font_size_cargo";
const STORAGE_KEY_OPACITY = "opacity_cargo";
const STORAGE_KEY_SHOW_DEST = "show_destination_cargo";
const STORAGE_KEY_SHOW_CALC = "show_calculator_cargo";
const STORAGE_KEY_SHOW_TRACKER = "show_tracker_cargo";
const STORAGE_KEY_SHOW_TRUCKING = "show_trucking_tracker";

// Trucking Storage Keys
const TRUCKING_STORAGE_KEY_CALC = "target_xp_trucking";
const TRUCKING_STORAGE_KEY_MINI = "mini_mode_trucking";
const TRUCKING_STORAGE_KEY_FONTSIZE = "font_size_trucking";
const TRUCKING_STORAGE_KEY_OPACITY = "opacity_trucking";
const TRUCKING_STORAGE_KEY_SHOW_CALC = "show_calculator_trucking";

let APP_VISIBLE = true;
let TRUCKING_VISIBLE = false;
let CONTROL_PANEL_VISIBLE = false;

let MEMORY = {
    inventory: {},
    trunk: {},
    weight: 0,
    lastTrunkUpdate: 0
};

let TRUCKING_MEMORY = {
    inventory: {},
    trunk: {},
    weight: 0,
    lastTrunkUpdate: 0
};

let TRUCKING_TRUNK_KEY = null;
let TRUCKING_LAST_VEHICLE = null;

const JOB_EXP_KEY = "exp_piloting_cargos";
const JOB_BXP_KEY = "exp_token_a|piloting|cargos";

const TRUCKING_JOB_EXP_KEY = "exp_trucking_trucking";
const TRUCKING_JOB_BXP_KEY = "exp_token_a|trucking|trucking";

const STATE = {
    currentXP: 0, 
    runActive: false,
    runStartXP: 0, 
    currentRunGain: 0, 
    completedRuns: 0,
    totalRunXP: 0, 
    avgRunXP: 0
};

const TRUCKING_STATE = {
    currentXP: 0, 
    runActive: false,
    runStartXP: 0, 
    currentRunGain: 0, 
    completedRuns: 0,
    totalRunXP: 0, 
    avgRunXP: 0
};

// --- INIT ---
const savedTarget = localStorage.getItem(STORAGE_KEY_CALC);
if (savedTarget) document.getElementById('target-input').value = savedTarget;

const savedMini = localStorage.getItem(STORAGE_KEY_MINI);
if (savedMini === "true") {
    document.getElementById('tracker-app').classList.add('mini-mode');
    document.getElementById('mini-btn').innerText = "FULL";
}

const savedFontSize = localStorage.getItem(STORAGE_KEY_FONTSIZE);
if (savedFontSize) {
    document.getElementById('content').style.fontSize = savedFontSize + '%';
    document.getElementById('font-size-display').innerText = savedFontSize + '%';
} else {
    document.getElementById('font-size-display').innerText = '100%';
}

const savedTruckingFontSize = localStorage.getItem(TRUCKING_STORAGE_KEY_FONTSIZE);
if (savedTruckingFontSize) {
    document.getElementById('trucking-content').style.fontSize = savedTruckingFontSize + '%';
    document.getElementById('trucking-font-size-display').innerText = savedTruckingFontSize + '%';
    document.getElementById('control-trucking-font-size').innerText = savedTruckingFontSize + '%';
} else {
    document.getElementById('trucking-font-size-display').innerText = '100%';
    document.getElementById('control-trucking-font-size').innerText = '100%';
}

const savedOpacity = localStorage.getItem(STORAGE_KEY_OPACITY);
if (savedOpacity) {
    document.getElementById('tracker-app').style.opacity = savedOpacity / 100;
    document.getElementById('opacity-slider').value = savedOpacity;
    document.getElementById('opacity-display').innerText = savedOpacity + '%';
    document.getElementById('control-opacity-slider').value = savedOpacity;
    document.getElementById('control-opacity-display').innerText = savedOpacity + '%';
} else {
    document.getElementById('opacity-display').innerText = '95%';
    document.getElementById('control-opacity-display').innerText = '95%';
}

const savedTruckingOpacity = localStorage.getItem(TRUCKING_STORAGE_KEY_OPACITY);
if (savedTruckingOpacity) {
    document.getElementById('trucking-tracker-app').style.opacity = savedTruckingOpacity / 100;
    document.getElementById('trucking-opacity-slider').value = savedTruckingOpacity;
    document.getElementById('trucking-opacity-display').innerText = savedTruckingOpacity + '%';
    document.getElementById('control-trucking-opacity').value = savedTruckingOpacity;
    document.getElementById('control-trucking-opacity-display').innerText = savedTruckingOpacity + '%';
} else {
    document.getElementById('trucking-opacity-display').innerText = '95%';
    document.getElementById('control-trucking-opacity-display').innerText = '95%';
}

const savedShowDest = localStorage.getItem(STORAGE_KEY_SHOW_DEST);
if (savedShowDest === 'false') {
    document.getElementById('show-destination').checked = false;
    document.getElementById('control-show-destination').checked = false;
    toggleDestination();
} else {
    document.getElementById('show-destination').checked = true;
    document.getElementById('control-show-destination').checked = true;
}

const savedShowCalc = localStorage.getItem(STORAGE_KEY_SHOW_CALC);
if (savedShowCalc === 'false') {
    document.getElementById('show-calculator').checked = false;
    document.getElementById('control-show-calculator').checked = false;
    toggleCalculator();
} else {
    document.getElementById('show-calculator').checked = true;
    document.getElementById('control-show-calculator').checked = true;
}

const savedShowTracker = localStorage.getItem(STORAGE_KEY_SHOW_TRACKER);
if (savedShowTracker === 'false') {
    document.getElementById('control-show-tracker').checked = false;
    document.getElementById('tracker-app').style.display = 'none';
    APP_VISIBLE = false;
} else {
    document.getElementById('control-show-tracker').checked = true;
}

const savedShowTrucking = localStorage.getItem(STORAGE_KEY_SHOW_TRUCKING);
if (savedShowTrucking === 'true') {
    document.getElementById('control-show-trucking').checked = true;
    document.getElementById('trucking-tracker-app').style.display = 'flex';
    TRUCKING_VISIBLE = true;
} else {
    document.getElementById('control-show-trucking').checked = false;
}

const savedShowTruckingCalc = localStorage.getItem(TRUCKING_STORAGE_KEY_SHOW_CALC);
if (savedShowTruckingCalc === 'false') {
    document.getElementById('show-trucking-calculator').checked = false;
    document.getElementById('control-show-trucking-calculator').checked = false;
    toggleTruckingCalculator();
} else {
    document.getElementById('show-trucking-calculator').checked = true;
    document.getElementById('control-show-trucking-calculator').checked = true;
}

// Sync control panel font size display
document.getElementById('control-font-size-display').innerText = document.getElementById('font-size-display').innerText;

// Initialize trucking target input
const savedTargetTrucking = localStorage.getItem(TRUCKING_STORAGE_KEY_CALC);
if (savedTargetTrucking) document.getElementById('trucking-target-input').value = savedTargetTrucking;

const savedMiniTrucking = localStorage.getItem(TRUCKING_STORAGE_KEY_MINI);
if (savedMiniTrucking === "true") {
    document.getElementById('trucking-tracker-app').classList.add('mini-mode');
    document.getElementById('trucking-mini-btn').innerText = "FULL";
}

function toggleMini() {
    const app = document.getElementById('tracker-app');
    app.classList.toggle('mini-mode');
    const isMini = app.classList.contains('mini-mode');
    document.getElementById('mini-btn').innerText = isMini ? "FULL" : "MINI";
    localStorage.setItem(STORAGE_KEY_MINI, isMini);
}

function toggleMiniTrucking() {
    const app = document.getElementById('trucking-tracker-app');
    app.classList.toggle('mini-mode');
    const isMini = app.classList.contains('mini-mode');
    document.getElementById('trucking-mini-btn').innerText = isMini ? "FULL" : "MINI";
    localStorage.setItem(TRUCKING_STORAGE_KEY_MINI, isMini);
}

function toggleSettings() {
    const panel = document.getElementById('settings-panel');
    const truckingPanel = document.getElementById('trucking-settings-panel');
    
    // Close trucking panel if open
    if (truckingPanel.classList.contains('show')) {
        truckingPanel.classList.remove('show');
    }
    
    // Toggle cargo panel
    panel.classList.toggle('show');
}

function toggleTruckingSettings() {
    const panel = document.getElementById('settings-panel');
    const truckingPanel = document.getElementById('trucking-settings-panel');
    
    // Close cargo panel if open
    if (panel.classList.contains('show')) {
        panel.classList.remove('show');
    }
    
    // Toggle trucking panel
    truckingPanel.classList.toggle('show');
}

function changeCargoFontSize(delta) {
    const content = document.getElementById('content');
    const display = document.getElementById('font-size-display');
    const controlDisplay = document.getElementById('control-font-size-display');
    let current = parseInt(localStorage.getItem(STORAGE_KEY_FONTSIZE) || '100');
    current += (delta * 10);
    current = Math.max(60, Math.min(200, current));
    content.style.fontSize = current + '%';
    display.innerText = current + '%';
    controlDisplay.innerText = current + '%';
    localStorage.setItem(STORAGE_KEY_FONTSIZE, current);
}

function changeTruckingFontSize(delta) {
    const truckingContent = document.getElementById('trucking-content');
    const truckingDisplay = document.getElementById('trucking-font-size-display');
    const controlDisplay = document.getElementById('control-trucking-font-size');
    let current = parseInt(localStorage.getItem(TRUCKING_STORAGE_KEY_FONTSIZE) || '100');
    current += (delta * 10);
    current = Math.max(60, Math.min(200, current));
    if (truckingContent) truckingContent.style.fontSize = current + '%';
    if (truckingDisplay) truckingDisplay.innerText = current + '%';
    if (controlDisplay) controlDisplay.innerText = current + '%';
    localStorage.setItem(TRUCKING_STORAGE_KEY_FONTSIZE, current);
}

function resetFontSize() {
    const content = document.getElementById('content');
    const display = document.getElementById('font-size-display');
    content.style.fontSize = '100%';
    display.innerText = '100%';
    localStorage.setItem(STORAGE_KEY_FONTSIZE, '100');
}

function changeCargoOpacity(value) {
    const app = document.getElementById('tracker-app');
    const display = document.getElementById('opacity-display');
    const controlDisplay = document.getElementById('control-opacity-display');
    
    app.style.opacity = value / 100;
    display.innerText = value + '%';
    controlDisplay.innerText = value + '%';
    document.getElementById('opacity-slider').value = value;
    document.getElementById('control-opacity-slider').value = value;
    
    localStorage.setItem(STORAGE_KEY_OPACITY, value);
}

function changeTruckingOpacity(value) {
    const truckingApp = document.getElementById('trucking-tracker-app');
    const truckingDisplay = document.getElementById('trucking-opacity-display');
    const controlDisplay = document.getElementById('control-trucking-opacity-display');
    
    if (truckingApp) truckingApp.style.opacity = value / 100;
    if (truckingDisplay) truckingDisplay.innerText = value + '%';
    if (controlDisplay) controlDisplay.innerText = value + '%';
    
    // Sync sliders
    if (document.getElementById('trucking-opacity-slider')) {
        document.getElementById('trucking-opacity-slider').value = value;
    }
    if (document.getElementById('control-trucking-opacity')) {
        document.getElementById('control-trucking-opacity').value = value;
    }
    
    localStorage.setItem(TRUCKING_STORAGE_KEY_OPACITY, value);
}

function minimizeUI() {
    document.getElementById('tracker-app').style.display = 'none';
    document.getElementById('minimized-bar').classList.add('show');
}

function restoreUI() {
    document.getElementById('tracker-app').style.display = 'flex';
    document.getElementById('minimized-bar').classList.remove('show');
}

function minimizeUITrucking() {
    document.getElementById('trucking-tracker-app').style.display = 'none';
}

function restoreUITrucking() {
    document.getElementById('trucking-tracker-app').style.display = 'flex';
}

function resetCargoSettings() {
    // Reset cargo font size
    const content = document.getElementById('content');
    content.style.fontSize = '100%';
    document.getElementById('font-size-display').innerText = '100%';
    document.getElementById('control-font-size-display').innerText = '100%';
    localStorage.setItem(STORAGE_KEY_FONTSIZE, '100');
    
    // Reset cargo opacity
    changeCargoOpacity(95);
    
    // Reset cargo destination
    document.getElementById('show-destination').checked = true;
    document.getElementById('control-show-destination').checked = true;
    localStorage.setItem(STORAGE_KEY_SHOW_DEST, 'true');
    document.getElementById('dest-box').style.display = 'flex';
    document.getElementById('dest-box').setAttribute('data-visible', 'true');
    
    // Reset cargo calculator
    document.getElementById('show-calculator').checked = true;
    document.getElementById('control-show-calculator').checked = true;
    localStorage.setItem(STORAGE_KEY_SHOW_CALC, 'true');
    const calcElements = ['calc-sep-1', 'calc-input-section', 'calc-sep-2', 'calc-result-section'];
    calcElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.style.display = el.classList.contains('stat-separator') ? 'block' : 'flex';
            el.setAttribute('data-visible', 'true');
        }
    });
}

function resetTruckingSettings() {
    // Reset trucking font size
    const truckingContent = document.getElementById('trucking-content');
    if (truckingContent) truckingContent.style.fontSize = '100%';
    document.getElementById('trucking-font-size-display').innerText = '100%';
    localStorage.setItem(TRUCKING_STORAGE_KEY_FONTSIZE, '100');
    
    // Reset trucking opacity
    changeTruckingOpacity(95);
    
    // Reset trucking calculator
    document.getElementById('show-trucking-calculator').checked = true;
    document.getElementById('control-show-trucking-calculator').checked = true;
    localStorage.setItem(TRUCKING_STORAGE_KEY_SHOW_CALC, 'true');
    const truckingCalcElements = ['trucking-calc-sep-1', 'trucking-calc-input-section', 'trucking-calc-sep-2', 'trucking-calc-result-section'];
    truckingCalcElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.style.display = el.classList.contains('stat-separator') ? 'block' : 'flex';
            el.setAttribute('data-visible', 'true');
        }
    });
}

function resetSettings() {
    // This is called from F2 control panel - resets both trackers
    resetCargoSettings();
    resetTruckingSettings();
    
    // Reset tracker visibility
    document.getElementById('control-show-tracker').checked = true;
    localStorage.setItem(STORAGE_KEY_SHOW_TRACKER, 'true');
    document.getElementById('tracker-app').style.display = 'flex';
    document.getElementById('minimized-bar').classList.remove('show');
    APP_VISIBLE = true;
}

function toggleDestination() {
    const checked = document.getElementById('show-destination').checked;
    const destBox = document.getElementById('dest-box');
    if (checked) {
        destBox.style.display = 'flex';
        destBox.setAttribute('data-visible', 'true');
    } else {
        destBox.style.display = 'none';
        destBox.setAttribute('data-visible', 'false');
    }
    // Sync with control panel
    document.getElementById('control-show-destination').checked = checked;
    localStorage.setItem(STORAGE_KEY_SHOW_DEST, checked);
}

function toggleCalculator() {
    const checked = document.getElementById('show-calculator').checked;
    const elements = [
        'calc-sep-1', 'calc-input-section', 'calc-sep-2', 'calc-result-section'
    ];
    elements.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            if (checked) {
                el.style.display = el.classList.contains('stat-separator') ? 'block' : 'flex';
                el.setAttribute('data-visible', 'true');
            } else {
                el.style.display = 'none';
                el.setAttribute('data-visible', 'false');
            }
        }
    });
    // Sync with control panel
    document.getElementById('control-show-calculator').checked = checked;
    localStorage.setItem(STORAGE_KEY_SHOW_CALC, checked);
}

function toggleDestinationFromControl() {
    document.getElementById('show-destination').checked = document.getElementById('control-show-destination').checked;
    toggleDestination();
}

function toggleCalculatorFromControl() {
    document.getElementById('show-calculator').checked = document.getElementById('control-show-calculator').checked;
    toggleCalculator();
}

function toggleTruckingCalculator() {
    const checked = document.getElementById('show-trucking-calculator').checked;
    const elements = [
        'trucking-calc-sep-1', 'trucking-calc-input-section', 'trucking-calc-sep-2', 'trucking-calc-result-section'
    ];
    elements.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            if (checked) {
                el.style.display = el.classList.contains('stat-separator') ? 'block' : 'flex';
                el.setAttribute('data-visible', 'true');
            } else {
                el.style.display = 'none';
                el.setAttribute('data-visible', 'false');
            }
        }
    });
    // Sync with control panel
    document.getElementById('control-show-trucking-calculator').checked = checked;
    localStorage.setItem(TRUCKING_STORAGE_KEY_SHOW_CALC, checked);
}

function toggleTruckingCalculatorFromControl() {
    document.getElementById('show-trucking-calculator').checked = document.getElementById('control-show-trucking-calculator').checked;
    toggleTruckingCalculator();
}

function toggleTrackerUI() {
    const checked = document.getElementById('control-show-tracker').checked;
    const app = document.getElementById('tracker-app');
    const miniBar = document.getElementById('minimized-bar');
    
    if (checked) {
        app.style.display = 'flex';
        miniBar.classList.remove('show');
        APP_VISIBLE = true;
    } else {
        app.style.display = 'none';
        miniBar.classList.remove('show');
        APP_VISIBLE = false;
    }
    localStorage.setItem(STORAGE_KEY_SHOW_TRACKER, checked);
}

function toggleTruckingUI() {
    const checked = document.getElementById('control-show-trucking').checked;
    const app = document.getElementById('trucking-tracker-app');
    
    if (checked) {
        app.style.display = 'flex';
        TRUCKING_VISIBLE = true;
    } else {
        app.style.display = 'none';
        TRUCKING_VISIBLE = false;
    }
    localStorage.setItem(STORAGE_KEY_SHOW_TRUCKING, checked);
}

function toggleControlPanel() {
    const panel = document.getElementById('control-panel');
    const overlay = document.getElementById('control-overlay');
    
    CONTROL_PANEL_VISIBLE = !CONTROL_PANEL_VISIBLE;
    
    if (CONTROL_PANEL_VISIBLE) {
        panel.classList.add('show');
        overlay.classList.add('show');
    } else {
        panel.classList.remove('show');
        overlay.classList.remove('show');
    }
}

function toggleAppVisibility() {
    toggleControlPanel();
}

// --- CLOCK ---
setInterval(() => {
    const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    document.getElementById('clock').innerText = time;
    document.getElementById('trucking-clock').innerText = time;
}, 1000);

// --- ENGINE ---
function requestData() {
    if(window.parent) {
        try { 
            let keys = [
                "exp_piloting_cargos", "exp_token_a|piloting|cargos",
                "exp_trucking_trucking", "exp_token_a|trucking|trucking",
                "inventory", "vehicle", "plate", 
                "chest", "trunkCapacity", "trunkWeight"
            ];
            if(TRUNK_KEY) keys.push(TRUNK_KEY);
            if(TRUCKING_TRUNK_KEY) keys.push(TRUCKING_TRUNK_KEY);
            window.parent.postMessage({ type: "getNamedData", keys: keys }, "*");
            window.parent.postMessage({ type: "getData" }, "*"); 
        } catch(e) {}
    }
}
setInterval(requestData, 1000); 

window.addEventListener('message', (event) => {
    let payload = event.data;
    if (payload && payload.type === 'data' && payload.data) payload = payload.data;
    if (!payload) return;

    processPayload(payload);
    processPayloadTrucking(payload);
});

function processPayload(data) {
    // 1. SMART VEHICLE DETECTION
    let incomingPlate = data.plate || data.vehicle;
    if (incomingPlate) {
        if(LAST_VEHICLE && LAST_VEHICLE !== incomingPlate) {
            MEMORY.trunk = {}; 
            MEMORY.weight = 0;
            TRUNK_KEY = null;
            STATE.runActive = false;
            STATE.currentRunGain = 0;
        }
        LAST_VEHICLE = incomingPlate;
    }

    // 2. TRUNK KEY DISCOVERY
    if(data.chest && typeof data.chest === 'string' && data.chest.includes("veh_")) {
        TRUNK_KEY = "chest_" + data.chest;
    }
    if(!TRUNK_KEY) {
        for(let key in data) {
            if(key.startsWith("chest_") && key.includes("veh_") && typeof data[key] === 'string' && data[key] !== "{}") {
                TRUNK_KEY = key;
                break;
            }
        }
    }

    // 3. PARSE INVENTORIES
    if(data.inventory) {
        try { MEMORY.inventory = (typeof data.inventory === 'string') ? JSON.parse(data.inventory) : data.inventory; } catch(e){}
    }
    
    // UPDATE WEIGHT
    if(data.trunkWeight !== undefined) MEMORY.weight = Math.round(data.trunkWeight);
    
    // TRUNK PARSING LOGIC
    let incomingTrunk = null;
    if(TRUNK_KEY && data[TRUNK_KEY]) {
        try { 
            if(data[TRUNK_KEY] !== "") {
                incomingTrunk = (typeof data[TRUNK_KEY] === 'string') ? JSON.parse(data[TRUNK_KEY]) : data[TRUNK_KEY];
            }
        } catch(e){}
    }

    const syncDot = document.getElementById('sync-status');
    const now = Date.now();

    if(incomingTrunk && Object.keys(incomingTrunk).length > 0) {
        MEMORY.trunk = incomingTrunk;
        MEMORY.lastTrunkUpdate = now;
        syncDot.className = "sync-dot live";
    } 
    else if (MEMORY.weight === 0) {
        MEMORY.trunk = {};
        MEMORY.lastTrunkUpdate = now;
        syncDot.className = "sync-dot live";
    }
    else {
        if(now - MEMORY.lastTrunkUpdate > 3000) {
            syncDot.className = "sync-dot cached";
        }
    }

    // 4. DESTINATION & RUN DETECTION
    let hasCargo = checkForCargo(MEMORY.inventory, MEMORY.trunk);
    
    // 5. XP LOGIC
    let currentXP = data[JOB_EXP_KEY];
    if(!currentXP && MEMORY.inventory[JOB_EXP_KEY]) currentXP = MEMORY.inventory[JOB_EXP_KEY];

    if (typeof currentXP === 'number') {
        updateRunLogic(currentXP, hasCargo);
        renderStats();
    }

    // 6. RENDER UI
    if(data.trunkCapacity !== undefined) {
        let txt = `${MEMORY.weight}/${Math.round(data.trunkCapacity)}kg`;
        document.getElementById('trunk-capacity').innerText = txt;
        document.getElementById('micro-weight').innerText = txt;
    }

    // 7. BXP LOGIC
    let bxp = data[JOB_BXP_KEY];
    if(!bxp && MEMORY.inventory[JOB_BXP_KEY]) bxp = MEMORY.inventory[JOB_BXP_KEY];
    if (bxp) {
        let val = (typeof bxp === 'object') ? bxp.amount : bxp;
        let txt = formatNumber(val);
        document.getElementById('disp-bxp').innerText = txt;
        document.getElementById('micro-tokens').innerText = txt;
    }
}

function processPayloadTrucking(data) {
    if (!TRUCKING_VISIBLE) return;
    
    // 1. SMART VEHICLE DETECTION
    let incomingPlate = data.plate || data.vehicle;
    if (incomingPlate) {
        if(TRUCKING_LAST_VEHICLE && TRUCKING_LAST_VEHICLE !== incomingPlate) {
            TRUCKING_MEMORY.trunk = {}; 
            TRUCKING_MEMORY.weight = 0;
            TRUCKING_TRUNK_KEY = null;
            TRUCKING_STATE.runActive = false;
            TRUCKING_STATE.currentRunGain = 0;
        }
        TRUCKING_LAST_VEHICLE = incomingPlate;
    }

    // 2. TRUNK KEY DISCOVERY
    if(data.chest && typeof data.chest === 'string' && data.chest.includes("veh_")) {
        TRUCKING_TRUNK_KEY = "chest_" + data.chest;
    }
    if(!TRUCKING_TRUNK_KEY) {
        for(let key in data) {
            if(key.startsWith("chest_") && key.includes("veh_") && typeof data[key] === 'string' && data[key] !== "{}") {
                TRUCKING_TRUNK_KEY = key;
                break;
            }
        }
    }

    // 3. PARSE INVENTORIES
    if(data.inventory) {
        try { TRUCKING_MEMORY.inventory = (typeof data.inventory === 'string') ? JSON.parse(data.inventory) : data.inventory; } catch(e){}
    }
    
    // UPDATE WEIGHT
    if(data.trunkWeight !== undefined) TRUCKING_MEMORY.weight = Math.round(data.trunkWeight);
    
    // TRUNK PARSING LOGIC
    let incomingTrunk = null;
    if(TRUCKING_TRUNK_KEY && data[TRUCKING_TRUNK_KEY]) {
        try { 
            if(data[TRUCKING_TRUNK_KEY] !== "") {
                incomingTrunk = (typeof data[TRUCKING_TRUNK_KEY] === 'string') ? JSON.parse(data[TRUCKING_TRUNK_KEY]) : data[TRUCKING_TRUNK_KEY];
            }
        } catch(e){}
    }

    const syncDot = document.getElementById('trucking-sync-status');
    const now = Date.now();

    if(incomingTrunk && Object.keys(incomingTrunk).length > 0) {
        TRUCKING_MEMORY.trunk = incomingTrunk;
        TRUCKING_MEMORY.lastTrunkUpdate = now;
        syncDot.className = "sync-dot live";
    } 
    else if (TRUCKING_MEMORY.weight === 0) {
        TRUCKING_MEMORY.trunk = {};
        TRUCKING_MEMORY.lastTrunkUpdate = now;
        syncDot.className = "sync-dot live";
    }
    else {
        if(now - TRUCKING_MEMORY.lastTrunkUpdate > 3000) {
            syncDot.className = "sync-dot cached";
        }
    }

    // 4. DESTINATION & RUN DETECTION
    let hasCargo = checkForCargoTrucking(TRUCKING_MEMORY.inventory, TRUCKING_MEMORY.trunk);
    
    // 5. XP LOGIC
    let currentXP = data[TRUCKING_JOB_EXP_KEY];
    if(!currentXP && TRUCKING_MEMORY.inventory[TRUCKING_JOB_EXP_KEY]) currentXP = TRUCKING_MEMORY.inventory[TRUCKING_JOB_EXP_KEY];

    if (typeof currentXP === 'number') {
        updateRunLogicTrucking(currentXP, hasCargo);
        renderStatsTrucking();
    }

    // 6. RENDER UI
    if(data.trunkCapacity !== undefined) {
        let txt = `${TRUCKING_MEMORY.weight}/${Math.round(data.trunkCapacity)}kg`;
        document.getElementById('trucking-trunk-capacity').innerText = txt;
        document.getElementById('trucking-micro-weight').innerText = txt;
    }

    // 7. BXP LOGIC
    let bxp = data[TRUCKING_JOB_BXP_KEY];
    if(!bxp && TRUCKING_MEMORY.inventory[TRUCKING_JOB_BXP_KEY]) bxp = TRUCKING_MEMORY.inventory[TRUCKING_JOB_BXP_KEY];
    if (bxp) {
        let val = (typeof bxp === 'object') ? bxp.amount : bxp;
        let txt = formatNumber(val);
        document.getElementById('trucking-disp-bxp').innerText = txt;
        document.getElementById('trucking-micro-tokens').innerText = txt;
    }
}

// --- FLIGHT SESSION LOGIC ---

function checkForCargo(pockets, trunk) {
    let cargoCounts = {}; // { "LSIA": 5, "SCA": 100 }
    let cargoFound = false;

    // Helper: Scans an inventory object and counts cargo types
    const scan = (inv) => {
        if(!inv) return;
        for (const key in inv) {
            const item = inv[key];
            
            // Normalize quantity (handle different data structures)
            let qty = 0;
            if (typeof item === 'number') qty = item;
            else if (typeof item === 'object') qty = item.amount || item.count || 0;
            
            if (qty <= 0) continue;

            const upperKey = key.toUpperCase();
            if(upperKey.includes("CARGO")) {
                for(const code in AIRPORTS) {
                    if (upperKey.includes(code)) {
                        if (!cargoCounts[code]) cargoCounts[code] = 0;
                        cargoCounts[code] += qty;
                        cargoFound = true;
                    }
                }
            }
        }
    };

    scan(trunk);
    scan(pockets);
    
    const box = document.getElementById('dest-box');
    const txt = document.getElementById('disp-destination');
    const warningEl = document.getElementById('multi-warning');
    const microDest = document.getElementById('micro-dest');
    
    if (!cargoFound) {
        txt.innerText = "Waiting for cargo...";
        microDest.innerText = "No Cargo";
        box.style.borderColor = "var(--accent)";
        box.style.background = "rgba(255, 193, 7, 0.1)";
        txt.style.color = "#fff";
        warningEl.style.display = "none";
        return false; 
    }

    const locations = Object.keys(cargoCounts);
    let bestLoc = locations[0];
    for (let loc of locations) {
        if (cargoCounts[loc] > cargoCounts[bestLoc]) {
            bestLoc = loc;
        }
    }

    let destText = `${bestLoc} - ${AIRPORTS[bestLoc]}`;
    txt.innerText = destText;
    microDest.innerText = destText.substring(0, 15);
    
    box.style.borderColor = "var(--green)";
    box.style.background = "rgba(0, 230, 118, 0.1)";
    txt.style.color = "var(--green)";

    if (locations.length > 1) {
        warningEl.style.display = "block";
        warningEl.innerText = `‚ö† Multiple Cargo Types ‚ö†`;
    } else {
        warningEl.style.display = "none";
    }

    return true; 
}

function updateRunLogic(currentXP, hasCargo) {
    if (STATE.currentXP === 0) STATE.currentXP = currentXP;

    // A. DETECT START OF RUN
    if (hasCargo && !STATE.runActive) {
        STATE.runActive = true;
        STATE.runStartXP = currentXP;
        STATE.currentRunGain = 0;
    }

    // B. TRACK XP DURING RUN
    if (STATE.runActive) {
        if (currentXP > STATE.runStartXP) {
            STATE.currentRunGain = currentXP - STATE.runStartXP;
        }
    }

    // C. DETECT END OF RUN (Delivery)
    if (!hasCargo && STATE.runActive) {
        STATE.completedRuns++;
        STATE.totalRunXP += STATE.currentRunGain;
        STATE.avgRunXP = STATE.totalRunXP / STATE.completedRuns;
        
        STATE.runActive = false;
        STATE.currentRunGain = 0;
    }

    STATE.currentXP = currentXP;
}

function renderStats() {
    const lvl = getLevelInfo(STATE.currentXP);
    const xpTxt = formatNumber(STATE.currentXP);
    
    document.getElementById('disp-xp').innerText = xpTxt;
    document.getElementById('micro-xp').innerText = xpTxt;
    
    document.getElementById('disp-level').innerText = lvl.level;
    document.getElementById('micro-level').innerText = lvl.level;
    
    const pct = getPercentValue(lvl.expInLevel, lvl.expForNext);
    document.getElementById('level-bar').style.width = pct + "%";
    document.getElementById('level-text').innerText = pct + "%";
    document.getElementById('micro-bar').style.width = pct + "%";

    document.getElementById('disp-flight-xp').innerText = formatNumber(STATE.currentRunGain) + " XP";
    document.getElementById('disp-flight-avg').innerText = Math.round(STATE.avgRunXP) + " XP";
    document.getElementById('disp-ops').innerText = STATE.completedRuns;

    const needed = Math.round(lvl.expForNext - lvl.expInLevel);
    document.getElementById('disp-xp-remaining').innerText = formatNumber(needed);

    runCalculator();
}

function checkForCargoTrucking(pockets, trunk) {
    let cargoCounts = {};
    let cargoFound = false;

    const scan = (inv) => {
        if(!inv) return;
        for (const key in inv) {
            const item = inv[key];
            
            let qty = 0;
            if (typeof item === 'number') qty = item;
            else if (typeof item === 'object') qty = item.amount || item.count || 0;
            
            if (qty <= 0) continue;

            const upperKey = key.toUpperCase();
            if(upperKey.includes("CARGO")) {
                for(const code in AIRPORTS) {
                    if (upperKey.includes(code)) {
                        if (!cargoCounts[code]) cargoCounts[code] = 0;
                        cargoCounts[code] += qty;
                        cargoFound = true;
                    }
                }
            }
        }
    };

    scan(trunk);
    scan(pockets);
    
    const microDest = document.getElementById('trucking-micro-dest');
    
    if (!cargoFound) {
        if (microDest) microDest.innerText = "No Cargo";
        return false; 
    }

    const locations = Object.keys(cargoCounts);
    let bestLoc = locations[0];
    for (let loc of locations) {
        if (cargoCounts[loc] > cargoCounts[bestLoc]) {
            bestLoc = loc;
        }
    }

    let destText = `${bestLoc} - ${AIRPORTS[bestLoc]}`;
    if (microDest) microDest.innerText = destText.substring(0, 15);

    return true; 
}

function updateRunLogicTrucking(currentXP, hasCargo) {
    if (TRUCKING_STATE.currentXP === 0) TRUCKING_STATE.currentXP = currentXP;

    // A. DETECT START OF RUN
    if (hasCargo && !TRUCKING_STATE.runActive) {
        TRUCKING_STATE.runActive = true;
        TRUCKING_STATE.runStartXP = currentXP;
        TRUCKING_STATE.currentRunGain = 0;
    }

    // B. TRACK XP DURING RUN
    if (TRUCKING_STATE.runActive) {
        if (currentXP > TRUCKING_STATE.runStartXP) {
            TRUCKING_STATE.currentRunGain = currentXP - TRUCKING_STATE.runStartXP;
        }
    }

    // C. DETECT END OF RUN (Delivery)
    if (!hasCargo && TRUCKING_STATE.runActive) {
        TRUCKING_STATE.completedRuns++;
        TRUCKING_STATE.totalRunXP += TRUCKING_STATE.currentRunGain;
        TRUCKING_STATE.avgRunXP = TRUCKING_STATE.totalRunXP / TRUCKING_STATE.completedRuns;
        
        TRUCKING_STATE.runActive = false;
        TRUCKING_STATE.currentRunGain = 0;
    }

    TRUCKING_STATE.currentXP = currentXP;
}

function renderStatsTrucking() {
    const lvl = getLevelInfo(TRUCKING_STATE.currentXP);
    const xpTxt = formatNumber(TRUCKING_STATE.currentXP);
    
    document.getElementById('trucking-disp-xp').innerText = xpTxt;
    document.getElementById('trucking-micro-xp').innerText = xpTxt;
    
    document.getElementById('trucking-disp-level').innerText = lvl.level;
    document.getElementById('trucking-micro-level').innerText = lvl.level;
    
    const pct = getPercentValue(lvl.expInLevel, lvl.expForNext);
    document.getElementById('trucking-level-bar').style.width = pct + "%";
    document.getElementById('trucking-level-text').innerText = pct + "%";
    document.getElementById('trucking-micro-bar').style.width = pct + "%";

    document.getElementById('trucking-disp-flight-xp').innerText = formatNumber(TRUCKING_STATE.currentRunGain) + " XP";
    document.getElementById('trucking-disp-flight-avg').innerText = Math.round(TRUCKING_STATE.avgRunXP) + " XP";
    document.getElementById('trucking-disp-ops').innerText = TRUCKING_STATE.completedRuns;

    const needed = Math.round(lvl.expForNext - lvl.expInLevel);
    document.getElementById('trucking-disp-xp-remaining').innerText = formatNumber(needed);

    runCalculatorTrucking();
}

function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(2) + "M";
    if (num >= 1000) return (num / 1000).toFixed(1) + "K";
    return num.toLocaleString();
}

function getLevelInfo(exp) {
    let level = 0, xpCap = 5;
    while (exp >= xpCap) { exp -= xpCap; level++; xpCap = (level + 1) * 5; }
    return { level, expInLevel: exp, expForNext: xpCap };
}

function getPercentValue(exp, cap) {
    return Math.min(100, Math.max(0, ((exp / cap) * 100))).toFixed(1);
}

// --- CALCULATOR ---
const calcInput = document.getElementById('target-input');
if(calcInput) calcInput.addEventListener('input', runCalculator);

const truckingCalcInput = document.getElementById('trucking-target-input');
if(truckingCalcInput) truckingCalcInput.addEventListener('input', runCalculatorTrucking);

function setCalc(amount) {
    document.getElementById('target-input').value = amount;
    runCalculator();
}

function setCalcTrucking(amount) {
    document.getElementById('trucking-target-input').value = amount;
    runCalculatorTrucking();
}

function runCalculator() {
    const val = document.getElementById('target-input').value;
    const el = document.getElementById('calc-result');
    const microEl = document.getElementById('micro-calc');
    
    localStorage.setItem(STORAGE_KEY_CALC, val);

    if (STATE.avgRunXP === 0) { 
        el.innerText = "Wait.."; 
        microEl.innerText = "Wait..";
        return; 
    }
    if (!val) { 
        el.innerText = "--"; 
        microEl.innerText = "Set..";
        return; 
    }

    let inputVal = parseInt(val.replace(/,/g, ''));
    let targetXP = inputVal;
    
    if (inputVal < 200) { 
         let lvlXP = 0; 
         for(let i=0; i<inputVal; i++) lvlXP += (5 * i * (i + 1)) / 2;
         targetXP = (5 * inputVal * (inputVal + 1)) / 2;
    }

    if (targetXP > STATE.currentXP) {
        const diff = targetXP - STATE.currentXP;
        const ops = Math.ceil(diff / STATE.avgRunXP);
        el.innerText = formatNumber(ops);
        microEl.innerText = formatNumber(ops);
    } else {
        el.innerText = "0";
        microEl.innerText = "Done";
    }
}

function runCalculatorTrucking() {
    const val = document.getElementById('trucking-target-input').value;
    const el = document.getElementById('trucking-calc-result');
    const microEl = document.getElementById('trucking-micro-calc');
    
    localStorage.setItem(TRUCKING_STORAGE_KEY_CALC, val);

    if (TRUCKING_STATE.avgRunXP === 0) { 
        el.innerText = "Wait.."; 
        microEl.innerText = "Wait..";
        return; 
    }
    if (!val) { 
        el.innerText = "--"; 
        microEl.innerText = "Set..";
        return; 
    }

    let inputVal = parseInt(val.replace(/,/g, ''));
    let targetXP = inputVal;
    
    if (inputVal < 200) { 
         let lvlXP = 0; 
         for(let i=0; i<inputVal; i++) lvlXP += (5 * i * (i + 1)) / 2;
         targetXP = (5 * inputVal * (inputVal + 1)) / 2;
    }

    if (targetXP > TRUCKING_STATE.currentXP) {
        const diff = targetXP - TRUCKING_STATE.currentXP;
        const ops = Math.ceil(diff / TRUCKING_STATE.avgRunXP);
        el.innerText = formatNumber(ops);
        microEl.innerText = formatNumber(ops);
    } else {
        el.innerText = "0";
        microEl.innerText = "Done";
    }
}

// --- TRUNK LIST UI ---
function renderTrunkList(trunk) {
    const el = document.getElementById('trunk-list');
    el.innerHTML = "";
    
    if((!trunk || Object.keys(trunk).length === 0) && MEMORY.weight > 0) {
        el.innerHTML = "<div style='color:var(--orange); font-style:italic;'>‚ö† Cargo Detected<br>(Open Trunk to Sync)</div>";
        return;
    }
    
    if(!trunk || Object.keys(trunk).length === 0) {
        el.innerHTML = "Cargo hold is empty.";
        return;
    }

    for(let key in trunk) {
        let item = trunk[key];
        let qty = item.amount || item.count || item;
        if(qty > 0) {
            el.innerHTML += `<div class="trunk-item"><span>${key}</span><span>x${qty}</span></div>`;
        }
    }
}

// --- DRAG HANDLER ---
let elmnt = document.getElementById("tracker-app");
let header = document.getElementById("drag-handle");
let microView = document.getElementById("micro-view");
let isDragging = false;
let startX, startY, initialLeft, initialTop;

header.addEventListener("mousedown", dragStart);
microView.addEventListener("mousedown", dragStart);

function dragStart(e) {
    if(e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'A') return;
    e.preventDefault();
    isDragging = true;
    startX = e.clientX;
    startY = e.clientY;
    const rect = elmnt.getBoundingClientRect();
    initialLeft = rect.left;
    initialTop = rect.top;
    document.addEventListener("mousemove", dragMove);
    document.addEventListener("mouseup", dragEnd);
}

function dragMove(e) {
    if (!isDragging) return;
    e.preventDefault();
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    elmnt.style.left = `${initialLeft + dx}px`;
    elmnt.style.top = `${initialTop + dy}px`;
}

function dragEnd() {
    isDragging = false;
    document.removeEventListener("mousemove", dragMove);
    document.removeEventListener("mouseup", dragEnd);
}

const rh = document.getElementById('resize-handle');
if (rh) {
    rh.addEventListener('mousedown', (e) => {
        e.preventDefault();
        window.addEventListener('mousemove', resize);
        window.addEventListener('mouseup', stopResize);
    });
}
function resize(e) {
    if(elmnt.classList.contains('mini-mode')) return;
    elmnt.style.width = Math.max(280, e.clientX - elmnt.getBoundingClientRect().left) + 'px';
    elmnt.style.height = Math.max(200, e.clientY - elmnt.getBoundingClientRect().top) + 'px';
}
function stopResize() {
    window.removeEventListener('mousemove', resize);
    window.removeEventListener('mouseup', stopResize);
}

// --- TRUCKING DRAG HANDLER ---
let truckingElmnt = document.getElementById("trucking-tracker-app");
let truckingHeader = document.getElementById("trucking-drag-handle");
let truckingMicroView = document.getElementById("trucking-micro-view");
let isTruckingDragging = false;
let truckingStartX, truckingStartY, truckingInitialLeft, truckingInitialTop;

truckingHeader.addEventListener("mousedown", dragStartTrucking);
truckingMicroView.addEventListener("mousedown", dragStartTrucking);

function dragStartTrucking(e) {
    if(e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'A') return;
    e.preventDefault();
    isTruckingDragging = true;
    truckingStartX = e.clientX;
    truckingStartY = e.clientY;
    const rect = truckingElmnt.getBoundingClientRect();
    truckingInitialLeft = rect.left;
    truckingInitialTop = rect.top;
    document.addEventListener("mousemove", dragMoveTrucking);
    document.addEventListener("mouseup", dragEndTrucking);
}

function dragMoveTrucking(e) {
    if (!isTruckingDragging) return;
    e.preventDefault();
    const dx = e.clientX - truckingStartX;
    const dy = e.clientY - truckingStartY;
    truckingElmnt.style.left = `${truckingInitialLeft + dx}px`;
    truckingElmnt.style.top = `${truckingInitialTop + dy}px`;
}

function dragEndTrucking() {
    isTruckingDragging = false;
    document.removeEventListener("mousemove", dragMoveTrucking);
    document.removeEventListener("mouseup", dragEndTrucking);
}

function dragMouseDownTrucking(event) {
    dragStartTrucking(event);
}

const rhTrucking = document.getElementById('trucking-resize-handle');
if (rhTrucking) {
    rhTrucking.addEventListener('mousedown', (e) => {
        e.preventDefault();
        window.addEventListener('mousemove', resizeTrucking);
        window.addEventListener('mouseup', stopResizeTrucking);
    });
}
function resizeTrucking(e) {
    if(truckingElmnt.classList.contains('mini-mode')) return;
    truckingElmnt.style.width = Math.max(280, e.clientX - truckingElmnt.getBoundingClientRect().left) + 'px';
    truckingElmnt.style.height = Math.max(200, e.clientY - truckingElmnt.getBoundingClientRect().top) + 'px';
}
function stopResizeTrucking() {
    window.removeEventListener('mousemove', resizeTrucking);
    window.removeEventListener('mouseup', stopResizeTrucking);
}

// Close settings panels when clicking outside
document.addEventListener('click', (e) => {
    const panel = document.getElementById('settings-panel');
    const truckingPanel = document.getElementById('trucking-settings-panel');
    const settingsIcons = document.querySelectorAll('.settings-icon');
    
    let clickedSettingsIcon = false;
    settingsIcons.forEach(icon => {
        if (e.target === icon) clickedSettingsIcon = true;
    });
    
    if (!clickedSettingsIcon) {
        if (panel.classList.contains('show') && !panel.contains(e.target)) {
            panel.classList.remove('show');
        }
        if (truckingPanel.classList.contains('show') && !truckingPanel.contains(e.target)) {
            truckingPanel.classList.remove('show');
        }
    }
});

// Close control panel when clicking overlay
document.getElementById('control-overlay').addEventListener('click', () => {
    toggleControlPanel();
});

// F2 Key Listener (Toggle Control Panel)
document.addEventListener('keydown', (e) => {
    if (e.key === 'F2') {
        e.preventDefault();
        toggleControlPanel();
    }
    
    // ESC to close control panel
    if (e.key === 'Escape' && CONTROL_PANEL_VISIBLE) {
        e.preventDefault();
        toggleControlPanel();
    }
});

// =================================================================
// CONTROL PANEL SYSTEM - FiveM Integration
// =================================================================
// The Control Panel is the main settings interface that appears when F2 is pressed
// It allows users to show/hide the main tracker UI and configure all settings
//
// KEYBOARD SHORTCUTS:
//   F2  - Toggle Control Panel on/off
//   ESC - Close Control Panel (when open)
//
// FIVEM INTEGRATION:
//   From your FiveM client script, you can control the panel:
//   SendNUIMessage({ type = "toggleControlPanel" })  -- Toggle control panel (same as F2)
//   SendNUIMessage({ type = "showControlPanel" })    -- Force show control panel
//   SendNUIMessage({ type = "hideControlPanel" })    -- Force hide control panel
//
// FEATURES:
//   - Show/Hide Main Tracker UI
//   - Show/Hide Destination Display
//   - Show/Hide Flight Calculator
//   - Adjust Font Size
//   - Adjust Opacity
//   - Reset All Settings
// =================================================================
window.addEventListener('message', (event) => {
    const data = event.data;
    
    // Check if message is from FiveM
    if (data && data.type === 'toggleControlPanel') {
        toggleControlPanel();
    }
    
    // Handle show/hide control panel commands
    if (data && data.type === 'showControlPanel') {
        if (!CONTROL_PANEL_VISIBLE) {
            toggleControlPanel();
        }
    }
    
    if (data && data.type === 'hideControlPanel') {
        if (CONTROL_PANEL_VISIBLE) {
            toggleControlPanel();
        }
    }
});
</script>
</body>
</html>
